name: Change settings

permissions:
  contents: read
  pages: write
  id-token: write

on:
  workflow_dispatch:
    inputs:
      azure-vault-name:
        description: 'Azure Key Vault'
        required: true
        type: string
        default: 'depa-inferencing-vault'
      deployment-name:
        description: 'Azure Confidential Ledger deployment name'
        required: true
        type: string
        default: 'depa-inferencing-kms'
      debugging:
        description: 'Enable debugging'
        required: true
        type: boolean
        default: true

jobs:
  change-settings:
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_AKS_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_AKS_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_AKS_SUBSCRIPTION_ID }}
                      
      - name: Install Azure CLI Confcom extension
        run: |
          az extension add --name confcom
          az extension update --name confcom
          az version

      - name: Setup Python virtual environment
        run: |
          # Create virtual environment
          python3 -m venv ccf_env
          
          # Activate virtual environment and install CCF
          source ccf_env/bin/activate
          pip install --upgrade pip
          pip install ccf==6.0.10
                    
          # Add virtual environment to PATH for subsequent steps
          echo "ccf_env/bin" >> $GITHUB_PATH

      - name: Generate settings policy proposal
        env: 
          DEBUGGING: ${{ inputs.debugging }}
        run: |
          cat > $GITHUB_WORKSPACE/settings_policy_proposal.json << EOF
          {
            "actions": [
              {
                "name": "set_settings_policy",
                "args": {
                  "settings_policy": {
                    "service": {
                      "name": "azure-privacy-sandbox-kms",
                      "description": "Key Management Service",
                      "version": "1.0.0",
                      "debug": $DEBUGGING
                    }
                  }
                }
              }
            ]
          }
          EOF

          echo "Settings policy proposal JSON generated: settings_policy_proposal.json"
          cat $GITHUB_WORKSPACE/settings_policy_proposal.json

      - name: Sign and submit settings policy proposal
        env:
          AZURE_VAULT_NAME: ${{ inputs.azure-vault-name }}
          KMS_DEPLOYMENT_NAME: ${{ inputs.deployment-name }}
          PROPOSAL: ${{ github.workspace }}/settings_policy_proposal.json
        run: |
          # Activate the virtual environment
          source ccf_env/bin/activate

          # Run the signing script
          ./tools/signing/sign.sh
  
      - name: Display current settings policy
        env: 
          KMS_DEPLOYMENT_NAME: ${{ inputs.deployment-name }}
        run: | 
          # Display the key release policy
          KMS_URL="https://${KMS_DEPLOYMENT_NAME}.confidential-ledger.azure.com"
          TOKEN=$(az account get-access-token --resource https://confidential-ledger.azure.com | jq -r '.accessToken')
          curl -k $KMS_URL/app/settingsPolicy -H "Content-Type: application/json" -H "Authorization: Bearer $TOKEN" | jq
