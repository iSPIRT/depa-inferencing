{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "containerGroupName": {
      "type": "string",
      "defaultValue": "kv-aci",
      "metadata": {
        "description": "Name for the container group"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "centralindia",
      "metadata": {
        "description": "Location for all resources"
      }
    },
    "cpu": {
      "type": "int",
      "defaultValue": 4,
      "metadata": {
        "description": "Number of CPU cores"
      }
    },
    "memoryInGb": {
      "type": "string",
      "defaultValue": "16",
      "metadata": {
        "description": "Amount of memory in GB"
      }
    },
    "port": {
      "type": "int",
      "defaultValue": 50051,
      "metadata": {
        "description": "Port to expose on the container group"
      }
    },
    "dnsLabelPrefix": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "DNS label prefix for the container group"
      }
    },
    "registryServer": {
      "type": "string",
      "defaultValue": "ispirt.azurecr.io",
      "metadata": {
        "description": "Container registry server"
      }
    },
    "registryUsername": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Container registry username"
      }
    },
    "registryPassword": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Container registry password"
      }
    },
    "env_KV_PORT": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "KV_PORT environment variable"
      }
    },
    "env_KV_HEALTHCHECK_PORT": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "KV_HEALTHCHECK_PORT environment variable"
      }
    },
    "env_AZURE_LOCAL_DATA_DIR": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "AZURE_LOCAL_DATA_DIR environment variable"
      }
    },
    "env_AZURE_LOCAL_REALTIME_DATA_DIR": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "AZURE_LOCAL_REALTIME_DATA_DIR environment variable"
      }
    },
    "env_AD_RETRIEVAL_KV_SERVER_ADDR": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "AD_RETRIEVAL_KV_SERVER_ADDR environment variable"
      }
    },
    "env_AD_RETRIEVAL_KV_SERVER_EGRESS_TLS": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "AD_RETRIEVAL_KV_SERVER_EGRESS_TLS environment variable"
      }
    },
    "env_AD_RETRIEVAL_TIMEOUT_MS": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "AD_RETRIEVAL_TIMEOUT_MS environment variable"
      }
    },
    "env_BUYER_EGRESS_TLS": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "BUYER_EGRESS_TLS environment variable"
      }
    },
    "env_COLLECTOR_ENDPOINT": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "COLLECTOR_ENDPOINT environment variable"
      }
    },
    "env_CONSENTED_DEBUG_TOKEN": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "CONSENTED_DEBUG_TOKEN environment variable"
      }
    },
    "env_ENABLE_AUCTION_COMPRESSION": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "ENABLE_AUCTION_COMPRESSION environment variable"
      }
    },
    "env_ENABLE_BUYER_COMPRESSION": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "ENABLE_BUYER_COMPRESSION environment variable"
      }
    },
    "env_ENABLE_CHAFFING": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "ENABLE_CHAFFING environment variable"
      }
    },
    "env_ENABLE_OTEL_BASED_LOGGING": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "ENABLE_OTEL_BASED_LOGGING environment variable"
      }
    },
    "env_ENABLE_PROTECTED_APP_SIGNALS": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "ENABLE_PROTECTED_APP_SIGNALS environment variable"
      }
    },
    "env_INFERENCE_MODEL_BUCKET_NAME": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "INFERENCE_MODEL_BUCKET_NAME environment variable"
      }
    },
    "env_INFERENCE_MODEL_BUCKET_PATHS": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "INFERENCE_MODEL_BUCKET_PATHS environment variable"
      }
    },
    "env_INFERENCE_MODEL_CONFIG_PATH": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "INFERENCE_MODEL_CONFIG_PATH environment variable"
      }
    },
    "env_INFERENCE_MODEL_FETCH_PERIOD_MS": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "INFERENCE_MODEL_FETCH_PERIOD_MS environment variable"
      }
    },
    "env_INFERENCE_MODEL_LOCAL_PATHS": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "INFERENCE_MODEL_LOCAL_PATHS environment variable"
      }
    },
    "env_INFERENCE_SIDECAR_BINARY_PATH": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "INFERENCE_SIDECAR_BINARY_PATH environment variable"
      }
    },
    "env_K_ANONYMITY_SERVER_ADDR": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "K_ANONYMITY_SERVER_ADDR environment variable"
      }
    },
    "env_K_ANONYMITY_SERVER_TIMEOUT_MS": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "K_ANONYMITY_SERVER_TIMEOUT_MS environment variable"
      }
    },
    "env_KV_SERVER_EGRESS_TLS": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "KV_SERVER_EGRESS_TLS environment variable"
      }
    },
    "env_MAX_ALLOWED_SIZE_DEBUG_URL_BYTES": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "MAX_ALLOWED_SIZE_DEBUG_URL_BYTES environment variable"
      }
    },
    "env_MAX_ALLOWED_SIZE_ALL_DEBUG_URLS_KB": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "MAX_ALLOWED_SIZE_ALL_DEBUG_URLS_KB environment variable"
      }
    },
    "env_PS_VERBOSITY": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "PS_VERBOSITY environment variable"
      }
    },
    "env_ROMA_TIMEOUT_MS": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "ROMA_TIMEOUT_MS environment variable"
      }
    },
    "env_SELECTION_KV_SERVER_ADDR": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "SELECTION_KV_SERVER_ADDR environment variable"
      }
    },
    "env_SELECTION_KV_SERVER_EGRESS_TLS": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "SELECTION_KV_SERVER_EGRESS_TLS environment variable"
      }
    },
    "env_SELECTION_KV_SERVER_TIMEOUT_MS": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "SELECTION_KV_SERVER_TIMEOUT_MS environment variable"
      }
    },
    "env_TEE_AD_RETRIEVAL_KV_SERVER_ADDR": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "TEE_AD_RETRIEVAL_KV_SERVER_ADDR environment variable"
      }
    },
    "env_TEE_KV_SERVER_ADDR": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "TEE_KV_SERVER_ADDR environment variable"
      }
    },
    "env_TELEMETRY_CONFIG": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "TELEMETRY_CONFIG environment variable"
      }
    },
    "env_AZURE_BA_PARAM_GET_TOKEN_URL": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "AZURE_BA_PARAM_GET_TOKEN_URL environment variable"
      }
    },
    "env_ENABLE_PROTECTED_AUDIENCE": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "ENABLE_PROTECTED_AUDIENCE environment variable"
      }
    },
    "env_KEY_REFRESH_FLOW_RUN_FREQUENCY_SECONDS": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "KEY_REFRESH_FLOW_RUN_FREQUENCY_SECONDS environment variable"
      }
    },
    "env_PRIMARY_COORDINATOR_ACCOUNT_IDENTITY": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "PRIMARY_COORDINATOR_ACCOUNT_IDENTITY environment variable"
      }
    },
    "env_PRIMARY_COORDINATOR_REGION": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "PRIMARY_COORDINATOR_REGION environment variable"
      }
    },
    "env_PRIVATE_KEY_CACHE_TTL_SECONDS": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "PRIVATE_KEY_CACHE_TTL_SECONDS environment variable"
      }
    }
  },
  "variables": {},
  "resources": [
    {
      "name": "[parameters('containerGroupName')]",
      "type": "Microsoft.ContainerInstance/containerGroups",
      "apiVersion": "2023-05-01",
      "location": "[parameters('location')]",
      "properties": {
        "osType": "Linux",
        "sku": "Confidential",
        "confidentialComputeProperties": {
            "ccePolicy": "cGFja2FnZSBwb2xpY3kKCmFwaV9zdm4gOj0gIjAuMTAuMCIKCm1vdW50X2RldmljZSA6PSB7ImFsbG93ZWQiOiB0cnVlfQptb3VudF9vdmVybGF5IDo9IHsiYWxsb3dlZCI6IHRydWV9CmNyZWF0ZV9jb250YWluZXIgOj0geyJhbGxvd2VkIjogdHJ1ZSwgImFsbG93X3N0ZGlvX2FjY2VzcyI6IHRydWV9CnVubW91bnRfZGV2aWNlIDo9IHsiYWxsb3dlZCI6IHRydWV9CnVubW91bnRfb3ZlcmxheSA6PSB7ImFsbG93ZWQiOiB0cnVlfQpleGVjX2luX2NvbnRhaW5lciA6PSB7ImFsbG93ZWQiOiB0cnVlfQpleGVjX2V4dGVybmFsIDo9IHsiYWxsb3dlZCI6IHRydWUsICJhbGxvd19zdGRpb19hY2Nlc3MiOiB0cnVlfQpzaHV0ZG93bl9jb250YWluZXIgOj0geyJhbGxvd2VkIjogdHJ1ZX0Kc2lnbmFsX2NvbnRhaW5lcl9wcm9jZXNzIDo9IHsiYWxsb3dlZCI6IHRydWV9CnBsYW45X21vdW50IDo9IHsiYWxsb3dlZCI6IHRydWV9CnBsYW45X3VubW91bnQgOj0geyJhbGxvd2VkIjogdHJ1ZX0KZ2V0X3Byb3BlcnRpZXMgOj0geyJhbGxvd2VkIjogdHJ1ZX0KZHVtcF9zdGFja3MgOj0geyJhbGxvd2VkIjogdHJ1ZX0KcnVudGltZV9sb2dnaW5nIDo9IHsiYWxsb3dlZCI6IHRydWV9CmxvYWRfZnJhZ21lbnQgOj0geyJhbGxvd2VkIjogdHJ1ZX0Kc2NyYXRjaF9tb3VudCA6PSB7ImFsbG93ZWQiOiB0cnVlfQpzY3JhdGNoX3VubW91bnQgOj0geyJhbGxvd2VkIjogdHJ1ZX0="
        },
        "restartPolicy": "Always",
        "ipAddress": {
          "type": "Public",
          "ports": [
            {
              "protocol": "TCP",
              "port": "[parameters('port')]"
            }
          ],
          "dnsNameLabel": "[parameters('dnsLabelPrefix')]"
        },
        "containers": [
          {
            "name": "[parameters('containerGroupName')]",
            "properties": {
              "image": "ispirt.azurecr.io/depa-inferencing/azure/key-value-service:nonprod-1.2.0.0",
              "resources": {
                "requests": {
                  "cpu": "[parameters('cpu')]",
                  "memoryInGb": "[json(parameters('memoryInGb'))]"
                }
              },
              "ports": [
                {
                  "protocol": "TCP",
                  "port": "[parameters('port')]"
                }
              ],
              "environmentVariables": [
                {
                  "name": "KV_PORT",
                  "value": "[parameters('env_KV_PORT')]"
                },
                {
                  "name": "KV_HEALTHCHECK_PORT",
                  "value": "[parameters('env_KV_HEALTHCHECK_PORT')]"
                },
                {
                  "name": "AZURE_LOCAL_DATA_DIR",
                  "value": "[parameters('env_AZURE_LOCAL_DATA_DIR')]"
                },
                {
                  "name": "AZURE_LOCAL_REALTIME_DATA_DIR",
                  "value": "[parameters('env_AZURE_LOCAL_REALTIME_DATA_DIR')]"
                },
                {
                  "name": "AD_RETRIEVAL_KV_SERVER_ADDR",
                  "value": "[parameters('env_AD_RETRIEVAL_KV_SERVER_ADDR')]"
                },
                {
                  "name": "AD_RETRIEVAL_KV_SERVER_EGRESS_TLS",
                  "value": "[parameters('env_AD_RETRIEVAL_KV_SERVER_EGRESS_TLS')]"
                },
                {
                  "name": "AD_RETRIEVAL_TIMEOUT_MS",
                  "value": "[parameters('env_AD_RETRIEVAL_TIMEOUT_MS')]"
                },
                {
                  "name": "BUYER_EGRESS_TLS",
                  "value": "[parameters('env_BUYER_EGRESS_TLS')]"
                },
                {
                  "name": "COLLECTOR_ENDPOINT",
                  "value": "[parameters('env_COLLECTOR_ENDPOINT')]"
                },
                {
                  "name": "CONSENTED_DEBUG_TOKEN",
                  "value": "[parameters('env_CONSENTED_DEBUG_TOKEN')]"
                },
                {
                  "name": "ENABLE_AUCTION_COMPRESSION",
                  "value": "[parameters('env_ENABLE_AUCTION_COMPRESSION')]"
                },
                {
                  "name": "ENABLE_BUYER_COMPRESSION",
                  "value": "[parameters('env_ENABLE_BUYER_COMPRESSION')]"
                },
                {
                  "name": "ENABLE_CHAFFING",
                  "value": "[parameters('env_ENABLE_CHAFFING')]"
                },
                {
                  "name": "ENABLE_OTEL_BASED_LOGGING",
                  "value": "[parameters('env_ENABLE_OTEL_BASED_LOGGING')]"
                },
                {
                  "name": "ENABLE_PROTECTED_APP_SIGNALS",
                  "value": "[parameters('env_ENABLE_PROTECTED_APP_SIGNALS')]"
                },
                {
                  "name": "INFERENCE_MODEL_BUCKET_NAME",
                  "value": "[parameters('env_INFERENCE_MODEL_BUCKET_NAME')]"
                },
                {
                  "name": "INFERENCE_MODEL_BUCKET_PATHS",
                  "value": "[parameters('env_INFERENCE_MODEL_BUCKET_PATHS')]"
                },
                {
                  "name": "INFERENCE_MODEL_CONFIG_PATH",
                  "value": "[parameters('env_INFERENCE_MODEL_CONFIG_PATH')]"
                },
                {
                  "name": "INFERENCE_MODEL_FETCH_PERIOD_MS",
                  "value": "[parameters('env_INFERENCE_MODEL_FETCH_PERIOD_MS')]"
                },
                {
                  "name": "INFERENCE_MODEL_LOCAL_PATHS",
                  "value": "[parameters('env_INFERENCE_MODEL_LOCAL_PATHS')]"
                },
                {
                  "name": "INFERENCE_SIDECAR_BINARY_PATH",
                  "value": "[parameters('env_INFERENCE_SIDECAR_BINARY_PATH')]"
                },
                {
                  "name": "K_ANONYMITY_SERVER_ADDR",
                  "value": "[parameters('env_K_ANONYMITY_SERVER_ADDR')]"
                },
                {
                  "name": "K_ANONYMITY_SERVER_TIMEOUT_MS",
                  "value": "[parameters('env_K_ANONYMITY_SERVER_TIMEOUT_MS')]"
                },
                {
                  "name": "KV_SERVER_EGRESS_TLS",
                  "value": "[parameters('env_KV_SERVER_EGRESS_TLS')]"
                },
                {
                  "name": "MAX_ALLOWED_SIZE_DEBUG_URL_BYTES",
                  "value": "[parameters('env_MAX_ALLOWED_SIZE_DEBUG_URL_BYTES')]"
                },
                {
                  "name": "MAX_ALLOWED_SIZE_ALL_DEBUG_URLS_KB",
                  "value": "[parameters('env_MAX_ALLOWED_SIZE_ALL_DEBUG_URLS_KB')]"
                },
                {
                  "name": "PS_VERBOSITY",
                  "value": "[parameters('env_PS_VERBOSITY')]"
                },
                {
                  "name": "ROMA_TIMEOUT_MS",
                  "value": "[parameters('env_ROMA_TIMEOUT_MS')]"
                },
                {
                  "name": "SELECTION_KV_SERVER_ADDR",
                  "value": "[parameters('env_SELECTION_KV_SERVER_ADDR')]"
                },
                {
                  "name": "SELECTION_KV_SERVER_EGRESS_TLS",
                  "value": "[parameters('env_SELECTION_KV_SERVER_EGRESS_TLS')]"
                },
                {
                  "name": "SELECTION_KV_SERVER_TIMEOUT_MS",
                  "value": "[parameters('env_SELECTION_KV_SERVER_TIMEOUT_MS')]"
                },
                {
                  "name": "TEE_AD_RETRIEVAL_KV_SERVER_ADDR",
                  "value": "[parameters('env_TEE_AD_RETRIEVAL_KV_SERVER_ADDR')]"
                },
                {
                  "name": "TEE_KV_SERVER_ADDR",
                  "value": "[parameters('env_TEE_KV_SERVER_ADDR')]"
                },
                {
                  "name": "TELEMETRY_CONFIG",
                  "value": "[parameters('env_TELEMETRY_CONFIG')]"
                },
                {
                  "name": "AZURE_BA_PARAM_GET_TOKEN_URL",
                  "value": "[parameters('env_AZURE_BA_PARAM_GET_TOKEN_URL')]"
                },
                {
                  "name": "AZURE_BA_PARAM_KMS_UNWRAP_URL",
                  "value": "https://depa-inferencing-kms.centralindia.cloudapp.azure.com/app/unwrapKey?fmt=tink"
                },
                {
                  "name": "ENABLE_PROTECTED_AUDIENCE",
                  "value": "[parameters('env_ENABLE_PROTECTED_AUDIENCE')]"
                },
                {
                  "name": "KEY_REFRESH_FLOW_RUN_FREQUENCY_SECONDS",
                  "value": "[parameters('env_KEY_REFRESH_FLOW_RUN_FREQUENCY_SECONDS')]"
                },
                {
                  "name": "PRIMARY_COORDINATOR_ACCOUNT_IDENTITY",
                  "value": "[parameters('env_PRIMARY_COORDINATOR_ACCOUNT_IDENTITY')]"
                },
                {
                  "name": "PRIMARY_COORDINATOR_PRIVATE_KEY_ENDPOINT",
                  "value": "https://depa-inferencing-kms.centralindia.cloudapp.azure.com/app/key?fmt=tink"
                },
                {
                  "name": "PRIMARY_COORDINATOR_REGION",
                  "value": "[parameters('env_PRIMARY_COORDINATOR_REGION')]"
                },
                {
                  "name": "PRIVATE_KEY_CACHE_TTL_SECONDS",
                  "value": "[parameters('env_PRIVATE_KEY_CACHE_TTL_SECONDS')]"
                },
                {
                  "name": "PUBLIC_KEY_ENDPOINT",
                  "value": "https://depa-inferencing-kms.centralindia.cloudapp.azure.com/app/listpubkeys"
                },
                {
                  "name": "SFE_PUBLIC_KEYS_ENDPOINTS",
                  "value": "{\"AZURE\":\"https://depa-inferencing-kms.centralindia.cloudapp.azure.com/app/listpubkeys\"}"
                },
                {
                  "name": "TEST_MODE",
                  "value": "false"
                }
              ]
            }
          }
        ]
      }
    }
  ]
}
